generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int       @id @default(autoincrement())
  email              String    @unique
  password           String
  name               String?
  phone              String?
  role               String    @default("user")
  level              String    @default("basic")
  tenantId           String?
  isVerified         Boolean   @default(false)
  isActive           Boolean   @default(true)
  lastLogin          DateTime?
  resetToken         String?
  resetTokenExpiry   DateTime?
  verificationToken  String?
  verificationExpiry DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  leaveBalances      LeaveBalance[]
  approvedLeaves     LeaveRequest[] @relation("ApprovedBy")
  leaveRequests      LeaveRequest[] @relation("UserLeaves")
  salaryStructures   SalaryStructure[]
  payslips           Payslip[]

  @@index([tenantId])
  @@map("users")
}

model LeaveBalance {
  id          Int      @id @default(autoincrement())
  userId      Int
  year        Int
  casualTotal Int      @default(12)
  casualUsed  Int      @default(0)
  sickTotal   Int      @default(6)
  sickUsed    Int      @default(0)
  annualTotal Int      @default(15)
  annualUsed  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, year])
  @@map("leave_balances")
}

model LeaveRequest {
  id          Int       @id @default(autoincrement())
  userId      Int
  type        String    // "CASUAL", "SICK", "ANNUAL", "MATERNITY", "PATERNITY", "UNPAID"
  fromDate    DateTime
  toDate      DateTime
  days        Int
  reason      String?
  status      String    @default("PENDING") // "PENDING", "APPROVED", "REJECTED", "CANCELLED"
  approvedBy  Int?
  approvedAt  DateTime?
  halfDay     Boolean   @default(false)
  halfDayType String?   // "FIRST_HALF", "SECOND_HALF"
  emergency   Boolean   @default(false)
  attachments String?   // Comma separated file paths or JSON
  comments    String?   // Comments from approver
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  admin User? @relation("ApprovedBy", fields: [approvedBy], references: [id])
  user  User  @relation("UserLeaves", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([fromDate, toDate])
  @@map("leave_requests")
}

model SalaryStructure {
  id            Int      @id @default(autoincrement())
  userId        Int
  earnings      Json
  deductions    Json
  effectiveFrom DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("salary_structures")
}

model Payslip {
  id          Int      @id @default(autoincrement())
  userId      Int
  month       Int
  year        Int
  earnings    Json
  deductions  Json
  grossPay    Float
  totalDeduct Float
  netPay      Float
  status      String   @default("GENERATED")
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, month, year])
  @@map("payslips")
}